<template
  ed-value.string="{}"
  $options="{}"
  language="json"
  @layout.stop="onLayout()"
>
  <meta name="module" pkg="esbuild-wasm" content="lib/browser.min.js" cjs />
  <meta name="module" pkg="lodash.debounce" cjs />
  <meta name="no-import-global-css" />
  <!-- <link
    rel="stylesheet"
    href="@/monaco-editor/min/vs/editor/editor.main.css"
    global="link"
  /> -->

  <link
    rel="stylesheet"
    href="@/@wcex/monaco-fixed@0.36.2/min/vs/editor/editor.main.css"
    global="link"
  />

  <style>
    :host {
      display: block;
    }

    .editor {
      width: 100%;
      height: 100%;
      z-index: 9;
    }
  </style>
  <div id="editor" class="editor"></div>
  <script scope="debounce" src="lodash.debounce" nocall></script>
  <script
    src="@/@wcex/monaco-fixed@0.36.2/min/vs/loader.js"
    amdloader="@wcex/monaco-fixed@0.36.2"
  ></script>
  <!-- <script
    src="@/monaco-editor/min/vs/loader.js"
    amdloader="monaco-editor"
  ></script> -->
  <script scope=".">
    var monacoPromise = new Promise((res) => {
      WCEX.amdloader["@wcex/monaco-fixed@0.36.2"].then((loader) => {
        loader.require.config({
          paths: { vs: WCEX.npmUrl + "@wcex/monaco-fixed@0.36.2/min/vs" },
        });
        loader.require(["vs/editor/editor.main"], async function () {
          res(window.monaco);
        });
      });
    });


    return class {
      __ExportEmits = ["edit", "ed-before-create", "ed-created"];
      async onReady() {
        let monaco = await monacoPromise;

        this.$emit("ed-before-create", { monaco });

        this.initEditor(monaco);

        this.$emit("ed-created", { monaco, editor: this.editor });

        this.$watch(
          () => this.edValue,
          () => {
            this.editor.setValue(this.edValue);
            this.editor.getAction("editor.action.formatDocument")?.run();
          }
        );

        // 编辑器发生改变，延迟500毫秒，仅在最后变化时发送消息
        this.editor.onDidChangeModelContent(
          this.debounce(
            (ev) => {
              this.$emit(
                new CustomEvent("edit", {
                  detail: { text: this.editor.getValue() },
                })
              );
            },
            1000,
            { leading: false, trailing: true }
          )
        );
      }
      initEditor(monaco) {
        this.editor = this.$noWatch(
          monaco.editor.create(
            this.$id.editor,
            Object.assign(
              {
                language: this.language,
                // minimap: { enabled: false },
                theme: this.$Colors.mode ? "vs" : "vs-dark",
                lineHeight: 20,
                // fontFamily: "Abel",
                // tabSize: 4,
                readOnly: false,
                scrollBeyondLastLine: false, // 为 false 时 格式化后不会滚动条顶部不会跳转到行末
              },
              this.options
            )
          )
        );
        this.editor.setValue(this.edValue);
      }
      onLayout() {
        requestAnimationFrame(() => {
          if (this.editor) this.editor.layout();
        });
      }
    };
  </script>
</template>
